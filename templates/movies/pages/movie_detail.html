{% extends 'base.html' %}

{% block title %}{{ pelicula.titulo }} - VivaStream{% endblock %}

{% block content %}
<div class="relative -mx-4 sm:-mx-6 lg:-mx-8 -mt-6">
    <div class="relative h-96 md:h-[500px] overflow-hidden">
        {% if pelicula.imagen %}
            <img src="{{ pelicula.imagen.url }}" 
                 alt="{{ pelicula.titulo }}"
                 class="w-full h-full object-cover">
        {% else %}
            <div class="w-full h-full bg-dark-gray"></div>
        {% endif %}
        
        <div class="absolute inset-0 bg-gradient-to-t from-dark-bg via-dark-bg/60 to-transparent"></div>
    </div>
    
    <div class="absolute bottom-0 left-0 right-0 p-8 md:p-12">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-4xl md:text-6xl font-bold mb-4 drop-shadow-lg">{{ pelicula.titulo }}</h1>
            
            <div class="flex flex-wrap items-center gap-4 text-sm md:text-base mb-6">
                <div class="flex flex-wrap gap-2">
                    {% for genero in pelicula.generos.all %}
                        <span class="bg-hbo-blue text-white px-3 py-1 rounded font-semibold">{{ genero.nombre }}</span>
                    {% endfor %}
                </div>
                {% if pelicula.año_publicacion %}
                    <span class="text-gray-300">{{ pelicula.año_publicacion }}</span>
                {% endif %}
                <span class="flex items-center gap-1">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-4H9V5h2v4z"/>
                    </svg>
                    {{ pelicula.duracion_formateada }}
                </span>
            </div>
            
            <div class="flex flex-wrap gap-4">
                {% if progreso and not progreso.completado %}
                    <a href="{% url 'movies:watch_movie' pelicula.id %}" class="flex items-center gap-2 bg-white text-black px-8 py-3 rounded-lg font-bold hover:bg-gray-200 transition">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M6 4l10 6-10 6V4z"/>
                        </svg>
                        Continuar viendo ({{ progreso.progreso_porcentaje|floatformat:0 }}%)
                    </a>
                {% else %}
                    <a href="{% url 'movies:watch_movie' pelicula.id %}" class="flex items-center gap-2 bg-white text-black px-8 py-3 rounded-lg font-bold hover:bg-gray-200 transition">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M6 4l10 6-10 6V4z"/>
                        </svg>
                        Reproducir
                    </a>
                {% endif %}

                {% include 'movies/components/favorite_button.html' %}
            </div>
        </div>
    </div>
</div>

<div class="mt-12 space-y-8">
    <div>
        <h2 class="text-2xl font-bold mb-4">Sinopsis</h2>
        <p class="text-gray-300 text-lg leading-relaxed">{{ pelicula.descripcion }}</p>
    </div>

    {% if peliculas_relacionadas %}
        <div class="mt-12 pt-8 border-t border-gray-700">
            <h2 class="text-2xl font-bold mb-6">Títulos Similares</h2>
            <p class="text-gray-400 text-sm mb-6">Basado en los géneros: 
                {% for genero in pelicula.generos.all %}
                    <span class="font-semibold">{{ genero.nombre }}</span>{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </p>
            
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 animate-stagger">
                {% for relacionada in peliculas_relacionadas %}
                    <a href="{% url 'movies:movie_detail' relacionada.id %}" class="block group">
                        <div class="relative rounded-lg overflow-hidden shadow-lg transition-all duration-700 ease-in-out transform hover:scale-103 hover:shadow-2xl cursor-pointer">
                            {% if relacionada.imagen %}
                                <img src="{{ relacionada.imagen.url }}" 
                                     alt="{{ relacionada.titulo }}"
                                     class="w-full h-64 object-cover">
                            {% else %}
                                <div class="w-full h-64 bg-dark-gray flex items-center justify-center">
                                    <span class="text-gray-500 text-sm">Sin imagen</span>
                                </div>
                            {% endif %}
                            
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-80 transition flex items-end">
                                <div class="opacity-0 group-hover:opacity-100 transition p-4 w-full space-y-2">
                                    <h3 class="font-bold text-sm">{{ relacionada.titulo }}</h3>
                                    <p class="text-xs text-gray-300">{{ relacionada.duracion_minutos }} min {% if relacionada.año_publicacion %}• {{ relacionada.año_publicacion }}{% endif %}</p>
                                    <div class="flex gap-1 flex-wrap">
                                        {% for genero in relacionada.generos.all %}
                                            <span class="bg-hbo-blue px-2 py-1 rounded text-xs">{{ genero.nombre }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </a>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <div class="mt-12 pt-8 border-t border-gray-700">
        {% include 'movies/components/rating_display.html' with calificacion_promedio=pelicula.calificacion_promedio total_calificaciones=pelicula.total_calificaciones rating_usuario=rating_usuario %}
    </div>
</div>
{% endblock %}